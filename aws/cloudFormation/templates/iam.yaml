# IAM (Identity and Access Management) in AWS is a service that securely manages user 
# identities, roles, and permissions to control access to AWS resources.

AWSTemplateFormatVersion: '2010-09-09'
Description: IAM roles orchestrator for Aubrisa Andes ECS tasks

Parameters:
  AppName:
    Type: String
  EnvironmentName:
    Type: String

  SqsQueueArn:
    Type: String
  EfsFileSystemId:
    Type: String

Resources:
  TaskExecutionRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/task-execution-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName


  ApiTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/api-task-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName
        EfsFileSystemId: !Ref EfsFileSystemId

  ChatTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/chat-task-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName

  UiTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/ui-task-role.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName

  ReportingTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/reporting-task-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName
        EfsFileSystemId: !Ref EfsFileSystemId

  LoadTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/load-task-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName
        SqsQueueArn: !Ref SqsQueueArn
        EfsFileSystemId: !Ref EfsFileSystemId

  AdjustmentsTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/adjustments-task-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName

  MurexTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: iam/murex-task-role.yaml
      Parameters:
        AppName: !Ref AppName
        EnvironmentName: !Ref EnvironmentName

Outputs:
  TaskExecutionRoleArn:
    Value: !GetAtt TaskExecutionRoleStack.Outputs.TaskExecutionRoleArn
  ApiTaskRoleArn:
    Value: !GetAtt ApiTaskRoleStack.Outputs.ApiTaskRoleArn
  ChatTaskRoleArn:
    Value: !GetAtt ChatTaskRoleStack.Outputs.ChatTaskRoleArn
  UiTaskRoleArn:
    Value: !GetAtt UiTaskRoleStack.Outputs.UiTaskRoleArn
  ReportingTaskRoleArn:
    Value: !GetAtt ReportingTaskRoleStack.Outputs.ReportingTaskRoleArn
  LoadTaskRoleArn:
    Value: !GetAtt LoadTaskRoleStack.Outputs.LoadTaskRoleArn
  AdjustmentsTaskRoleArn:
    Value: !GetAtt AdjustmentsTaskRoleStack.Outputs.AdjustmentsTaskRoleArn
  MurexTaskRoleArn:
    Value: !GetAtt MurexTaskRoleStack.Outputs.MurexTaskRoleArn